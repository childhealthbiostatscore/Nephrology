---
title: "child_analyitic_cohort"
author: "Casey Sakamoto"
date: "2025-01-27"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)

# Set up paths and read data
# Adjust file paths to match your system
tab_1_person <- read.csv("S:/Sakamoto/Nephrology/Data/Table1 Person Table.csv")
tab_2_encount <- read.csv("S:/Sakamoto/Nephrology/Data/Table2 Encounter Table.csv")
tab_4_labs <- read.csv("S:/Sakamoto/Nephrology/Data/Table 4 Labs.csv")

```

QUESTIONS:

TAB1PERSON:
- code references Days_from_DOB_to_Epic_DOD (current dataset has), Days_from_DOB_to_CDPHE_DOD variables -- where is this one derived from/is it not used anymore?

OVERALL -- figure out where merges happen

```{r johns code, include=FALSE}
# Step 1: Initial data setup
AKI_COMPASS_DATA_T1 <- tab_1_person

# Step 2: Derive and clean up variables


# Create Diff_DOD and ID_DOD_89 variables
AKI_COMPASS_DATA_T1 <- AKI_COMPASS_DATA_T1 %>%
  mutate(
    Diff_DOD = abs(Days_from_DOB_to_Epic_DOD - Days_from_DOB_to_CDPHE_DOD),
    ID_DOD_89 = ifelse(is.na(Days_from_DOB_to_Epic_DOD) & is.na(Days_from_DOB_to_CDPHE_DOD), NA,
                  ifelse(Days_from_DOB_to_Epic_DOD == "" | Days_from_DOB_to_CDPHE_DOD == "", 1, 0))
  )

# Step 3: Frequency and descriptive statistics
# Frequency table
freq_table <- AKI_COMPASS_DATA_T1 %>%
  summarise(across(c(Sex, Race, Ethnicity, Death_YN), ~sum(is.na(.))))

# Summary statistics for `DaysDOBtoEpicDeath`
summary_stats <- AKI_COMPASS_DATA_T1 %>%
  summarise(
    n = n(),
    nmiss = sum(is.na(DaysDOBtoEpicDeath)),
    mean = mean(DaysDOBtoEpicDeath, na.rm = TRUE),
    median = median(DaysDOBtoEpicDeath, na.rm = TRUE),
    q1 = quantile(DaysDOBtoEpicDeath, 0.25, na.rm = TRUE),
    q3 = quantile(DaysDOBtoEpicDeath, 0.75, na.rm = TRUE),
    min = min(DaysDOBtoEpicDeath, na.rm = TRUE),
    max = max(DaysDOBtoEpicDeath, na.rm = TRUE)
  )

# Step 4: Filter data for large differences
play_data_365 <- AKI_COMPASS_DATA_T1 %>%
  filter(Diff_DOD > 365)

play_data_7 <- AKI_COMPASS_DATA_T1 %>%
  filter(Diff_DOD > 7)

# Step 5: Subset data for analysis
#AKI_COMPASS_DATA_T2 <- tab_2_encount
AKI_COMPASS_DATA_T2 <- tab_2_encount %>%
  filter(ArbPersonID %in% AKI_COMPASS_DATA_T1$ArbPersonID)

# Step 6: Derive Age-based flags
first <- AKI_COMPASS_DATA_T2 %>%
  arrange(ArbPersonID, AgeDays) %>%
  group_by(ArbPersonID) %>%
  slice(1) %>%
  ungroup()

first_X_age <- first %>%
  mutate(
    FLAG_missing_age = is.na(AgeDays),
    FLAG_kid_age = ifelse(AgeDays <= 6570 & AgeDays > 0, TRUE, FALSE)
  )

# Step 7: Frequency and summary statistics
age_flags_summary <- first_X_age %>%
  summarise(
    missing_age_flag = sum(FLAG_missing_age, na.rm = TRUE),
    kid_age_flag = sum(FLAG_kid_age, na.rm = TRUE)
  )

baseline_summary <- first_X_age %>%
  summarise(
    n = n(),
    nmiss = sum(is.na(BaselineResultValue)),
    mean = mean(BaselineResultValue, na.rm = TRUE),
    median = median(BaselineResultValue, na.rm = TRUE),
    q1 = quantile(BaselineResultValue, 0.25, na.rm = TRUE),
    q3 = quantile(BaselineResultValue, 0.75, na.rm = TRUE),
    min = min(BaselineResultValue, na.rm = TRUE),
    max = max(BaselineResultValue, na.rm = TRUE)
  )

# Step 8: Filter unreasonable BaselineResultValue
over_8 <- first_X_age %>%
  filter(BaselineResultValue > 8)

# Step 9: Lab data analysis
labs_cr <- tab_4_labs %>%
  filter(LabCompName %in% c("POCT Creatinine", "Creatinine, Serum/Plasma", "Creatinine Serum/Plasma - U")) %>%
  mutate(
    Stage1_flag = ifelse((DaysFromDOBtoCollection - AgeDays <= 2 & NumericValue - BaselineResultValue >= 0.3) |
                           (DaysFromDOBtoCollection - AgeDays <= 7 & NumericValue / BaselineResultValue >= 1.5), 1, 0),
    Stage2_flag = ifelse(NumericValue / BaselineResultValue >= 2, 1, 0),
    Stage3_flag = ifelse(NumericValue / BaselineResultValue >= 3 | NumericValue >= 4, 1, 0),
    Stage = case_when(
      Stage1_flag == 1 ~ 1,
      Stage2_flag == 1 ~ 2,
      Stage3_flag == 1 ~ 3,
      TRUE ~ 0
    )
  )

# Output frequency of stages
stage_summary <- labs_cr %>%
  group_by(Stage) %>%
  summarise(count = n())


```
